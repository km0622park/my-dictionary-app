name: Build Android APK
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'

      - name: Build APK (Auto-Fix)
        run: |
          # 1. 프로젝트 폴더 위치 찾기 (어디에 있든 찾아냄)
          PROJECT_DIR=$(find . -name pubspec.yaml -exec dirname {} \; | head -n 1)
          echo "Project found at: $PROJECT_DIR"
          cd "$PROJECT_DIR"

          # 2. Android 폴더가 없으면 자동 생성 (에러 방지)
          if [ ! -d "android" ]; then
            echo "Generating Android folder..."
            flutter create . --platforms android --org com.example.antigravity
          fi

          # 3. 설정 파일 자동 패치 (호환성 해결)
          if [ -f "android/app/build.gradle" ]; then
             sed -i 's/minSdkVersion [0-9]*/minSdkVersion 21/g' android/app/build.gradle
             sed -i 's/minSdkVersion flutter.minSdkVersion/minSdkVersion 21/g' android/app/build.gradle
          fi

          # 4. 진짜 빌드 시작
          flutter pub get
          flutter build apk --release --no-tree-shake-icons
          
          # 5. 결과물 안전한 곳으로 이동
          mkdir -p $GITHUB_WORKSPACE/apk_result
          cp build/app/outputs/flutter-apk/app-release.apk $GITHUB_WORKSPACE/apk_result/

      - uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: apk_result/app-release.apk
